# 🔔 알림 기능 테스트 가이드

## 구현된 알림 기능

### 1. 📢 공지사항 작성 시
- **대상**: 모든 활성 사용자
- **발송 시점**: 관리자가 새 공지사항 작성 시
- **알림 내용**: 공지사항 제목
- **이동 경로**: 해당 공지사항 상세 페이지

### 2. 📦 주문 완료 시
- **대상**: 주문한 사용자
- **발송 시점**: 주문 생성 완료 시
- **알림 내용**: "주문이 정상적으로 완료되었습니다. (상품명)"
- **이동 경로**: 마이페이지 > 주문 내역

### 3. ⭐ 리뷰 답글 등록 시
- **대상**: 리뷰 작성자
- **발송 시점**: 관리자나 다른 사용자가 리뷰에 답글 작성 시
- **알림 내용**: "작성하신 리뷰에 답글이 등록되었습니다."
- **이동 경로**: 마이페이지 > 나의 리뷰
- **참고**: 자기 자신의 리뷰에 답글을 단 경우 알림 제외

### 4. ❓ Q&A 답변 등록 시
- **대상**: Q&A 작성자
- **발송 시점**: 관리자나 다른 사용자가 Q&A에 답변 작성 시
- **알림 내용**: "문의하신 내용에 답변이 등록되었습니다."
- **이동 경로**: 마이페이지 > 나의 문의
- **참고**: 자기 자신의 Q&A에 답변을 단 경우 알림 제외

---

## 🧪 테스트 시나리오

### 시나리오 1: 공지사항 알림 테스트

**준비물**: 
- 일반 사용자 계정 (예: user1)
- 관리자 계정

**테스트 순서**:
1. user1으로 로그인
2. 헤더의 종 아이콘 확인 (숫자 없음)
3. 로그아웃
4. 관리자로 로그인
5. 관리자 페이지 > 공지사항 > 글쓰기
6. 새 공지사항 작성 및 등록
   - 제목: "테스트 공지사항"
   - 내용: "알림 테스트입니다."
7. 로그아웃
8. user1으로 다시 로그인
9. ✅ **종 아이콘에 빨간 뱃지 표시 확인**
10. 종 아이콘 클릭 → 알림 페이지 이동
11. ✅ **"📢 새로운 공지사항" 알림 확인**
12. 알림 클릭 → 해당 공지사항으로 이동
13. ✅ **읽지 않은 알림 개수 감소 확인**

---

### 시나리오 2: 주문 완료 알림 테스트

**준비물**:
- 일반 사용자 계정 (예: user1)
- 장바구니에 상품 추가

**테스트 순서**:
1. user1으로 로그인
2. 상품 상세 페이지에서 장바구니에 상품 추가
3. 장바구니로 이동
4. "주문하기" 클릭
5. 배송 정보 입력
6. 결제 방법 선택 (무통장입금 또는 카드)
7. "결제하기" 클릭
8. ✅ **종 아이콘에 빨간 뱃지 표시 확인**
9. 종 아이콘 클릭 → 알림 페이지 이동
10. ✅ **"📦 주문 완료" 알림 확인**
11. 알림 내용에 주문한 상품명이 포함되어 있는지 확인
12. 알림 클릭 → 마이페이지 > 주문 내역으로 이동

---

### 시나리오 3: 리뷰 답글 알림 테스트

**준비물**:
- 일반 사용자 계정 2개 (user1, user2) 또는 관리자 계정
- user1이 작성한 리뷰

**테스트 순서**:
1. user1으로 로그인
2. 구매한 상품의 리뷰 작성
   - 내용: "좋은 상품입니다!"
   - 평점: 5점
3. 로그아웃
4. user2(또는 관리자)로 로그인
5. 해당 리뷰에 답글 작성
   - 내용: "좋은 리뷰 감사합니다!"
6. 로그아웃
7. user1으로 다시 로그인
8. ✅ **종 아이콘에 빨간 뱃지 표시 확인**
9. 종 아이콘 클릭 → 알림 페이지 이동
10. ✅ **"⭐ 리뷰 답글 등록" 알림 확인**
11. 알림 클릭 → 마이페이지 > 나의 리뷰로 이동

---

### 시나리오 4: Q&A 답변 알림 테스트

**준비물**:
- 일반 사용자 계정 (user1)
- 관리자 계정

**테스트 순서**:
1. user1으로 로그인
2. 상품 상세 페이지 > Q&A 작성
   - 제목: "재고 문의"
   - 내용: "이 상품 언제 재입고되나요?"
3. 로그아웃
4. 관리자로 로그인
5. 관리자 페이지 > Q&A 관리
6. 해당 Q&A에 답변 작성
   - 답변: "다음 주 월요일에 재입고 예정입니다."
7. 로그아웃
8. user1으로 다시 로그인
9. ✅ **종 아이콘에 빨간 뱃지 표시 확인**
10. 종 아이콘 클릭 → 알림 페이지 이동
11. ✅ **"❓ Q&A 답변 등록" 알림 확인**
12. 알림 클릭 → 마이페이지 > 나의 문의로 이동

---

## 🔍 데이터베이스 확인

알림이 정상적으로 생성되었는지 MySQL에서 직접 확인:

```sql
-- 최근 알림 조회
SELECT 
    n.id,
    u.user_id,
    n.title,
    n.content,
    n.type,
    n.is_read,
    n.created_at
FROM notifications n
JOIN user u ON n.user_id = u.id
ORDER BY n.created_at DESC
LIMIT 20;

-- 특정 사용자의 읽지 않은 알림
SELECT 
    n.id,
    n.title,
    n.content,
    n.type,
    n.created_at
FROM notifications n
JOIN user u ON n.user_id = u.id
WHERE u.user_id = 'user1' AND n.is_read = FALSE
ORDER BY n.created_at DESC;

-- 알림 타입별 개수
SELECT 
    type,
    COUNT(*) as count,
    SUM(CASE WHEN is_read = FALSE THEN 1 ELSE 0 END) as unread_count
FROM notifications
GROUP BY type;
```

---

## 📝 서버 로그 확인

알림 생성 시 로그가 출력되는지 확인:

```
# 공지사항 알림
공지사항 생성 - 총 5명의 사용자에게 알림 전송

# 주문 완료 알림
주문 알림 전송 성공: userId=user1, orderId=123

# 리뷰 답글 알림
리뷰 답글 알림 전송 성공: userId=user1, reviewId=45

# Q&A 답변 알림
Q&A 답변 알림 전송 성공: userId=user1, qnaId=67
```

---

## ⚠️ 주의사항

1. **알림 전송 실패해도 작업은 정상 처리**
   - 공지사항 등록, 주문 완료, 답글 작성 등은 알림 전송 실패와 무관하게 정상 처리됩니다.
   - 알림 전송 실패 시 로그에 에러가 기록됩니다.

2. **자기 자신에게는 알림 미전송**
   - 리뷰나 Q&A에 자기 자신이 답글을 작성해도 알림이 가지 않습니다.

3. **30초마다 자동 갱신**
   - 로그인 상태에서 30초마다 읽지 않은 알림 개수가 자동으로 갱신됩니다.

4. **성능 고려사항**
   - 공지사항 작성 시 모든 사용자에게 알림을 전송하므로, 사용자가 많을 경우 시간이 걸릴 수 있습니다.
   - 대량의 사용자가 있는 경우, 비동기 처리를 고려해야 합니다.

---

## 🐛 트러블슈팅

### 알림이 생성되지 않는 경우

1. **데이터베이스 확인**
   ```sql
   SELECT COUNT(*) FROM notifications;
   ```
   - 0이면 알림이 전혀 생성되지 않은 것

2. **서버 로그 확인**
   - "알림 전송 실패" 로그가 있는지 확인
   - 에러 메시지 내용 확인

3. **userId 확인**
   - Review와 Qna 엔티티에서 올바른 userId를 가져오는지 확인

### 알림 개수가 업데이트되지 않는 경우

1. **브라우저 콘솔 확인**
   ```javascript
   console.log(window.store.getState().notification);
   ```

2. **API 호출 확인**
   - Network 탭에서 `/api/notifications/unread-count` 호출 확인

3. **Redux Store 확인**
   - Redux DevTools로 notificationSlice 상태 확인

---

## 🎉 모든 테스트 통과 시

축하합니다! 알림 시스템이 완벽하게 작동하고 있습니다! 🎊

이제 실제 운영 환경에서도 사용자들이 다양한 이벤트에 대한 알림을 실시간으로 받을 수 있습니다.
